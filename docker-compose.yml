services:

  # --- Gravitee API Management Components ---

  ### MongoDB
  mongodb:
    image: mongo:${MONGODB_VERSION:-8.0.18} # https://hub.docker.com/_/mongo/tags?name=8.0
    container_name: gio-apim-mongodb
    restart: always
    volumes:
      - data-mongo:/data/db
    healthcheck:
      test: mongosh --eval 'db.runCommand({serverStatus:1}).ok' --quiet | grep 1
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - southbound

  ### Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION:-9.2.5} # https://www.docker.elastic.co/r/elasticsearch/elasticsearch
    container_name: gio-apim-elasticsearch
    restart: always
    ports:
      - "9200:9200"
    volumes:
      - data-elasticsearch:/usr/share/elasticsearch/data
    environment:
      - http.host=0.0.0.0
      - http.port=9200
      - http.cors.allow-origin=http://localhost:1358,http://127.0.0.1:1358
      - http.cors.enabled=true
      - http.cors.allow-headers=X-Requested-With,X-Auth-Token,Content-Type,Content-Length,Authorization
      - http.cors.allow-credentials=true
      - transport.host=0.0.0.0
      - xpack.security.enabled=false
      - cluster.name=elasticsearch
      - bootstrap.memory_lock=true
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile: 65536
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=5s" ]
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - southbound

  ### Kibana (Elasticsearch UI, to explore in depth the data stored in Elasticsearch, useful for token consumption analytics, not yet visible in the APIM UI (planned 4.11))
  # kibana:
  #   image: docker.elastic.co/kibana/kibana:${ELASTIC_VERSION:-9.2.5} # https://www.docker.elastic.co/r/kibana/kibana
  #   container_name: gio-apim-kibana
  #   restart: always
  #   ports:
  #     - "5601:5601"
  #   depends_on:
  #     elasticsearch:
  #       condition: service_healthy
  #   volumes:
  #     - data-kibana:/usr/share/kibana/data
  #   environment:
  #     ELASTICSEARCH_HOSTS: '["http://elasticsearch:9200"]'
  #   networks:
  #     - southbound

  ### Gravitee API Management Gateway
  apim-gateway:
    image: ${APIM_REGISTRY:-graviteeio}/apim-gateway:${APIM_VERSION_GATEWAY:-latest} # https://hub.docker.com/r/graviteeio/apim-gateway/tags?name=4.10
    container_name: gio-apim-gateway
    restart: always
    ports:
      - "8082:8082" # Gateway Entrypoint for HTTP / TCP traffic
      - "18082:18082" # Internal API, used for monitoring and management purposes
    depends_on:
      mongodb:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: >
        sh -c ' response=$$(curl -s -u admin:adminadmin http://localhost:18082/_node/health); status=$$(echo "$$response" | grep "\"healthy\": true"); if [ -z "$$status" ]; then echo "false"; else echo "true"; fi ' > /dev/null
      interval: 2s
      timeout: 2s
      retries: 10
    volumes:
      - ./apim-gateway-models:/opt/graviteeio-gateway/models
      - ./plugins-apim:/opt/graviteeio-gateway/plugins-ext
    environment:
      ### TIMEOUT
      - gravitee_http_requestTimeout=120000
      ### LICENSE
      - gravitee_license_key=${GRAVITEE_LICENSE}
      ### PLUGINS
      - gravitee_plugins_path_0=/opt/graviteeio-gateway/plugins
      - gravitee_plugins_path_1=/opt/graviteeio-gateway/plugins-ext
      ### Internal API (Core Service)
      - gravitee_services_core_http_host=0.0.0.0
      - gravitee_services_metrics_enabled=true
      - gravitee_services_metrics_prometheus_enabled=true
      ### MANAGEMENT DB - MONGO DB
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=20000&socketTimeoutMS=20000
      ### RATE LIMIT DB - MONGO DB
      - gravitee_ratelimit_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=20000&socketTimeoutMS=20000
      ### REPORTER - ES
      - gravitee_reporters_elasticsearch_endpoints_0=http://elasticsearch:9200
      ### ALERT ENGINE
      - gravitee_alerts_alertengine_enabled=true
      - gravitee_alerts_alertengine_ws_discovery=true
      - gravitee_alerts_alertengine_ws_endpoints_0=http://alert-engine:8072
      - gravitee_alerts_alertengine_ws_security_username=admin
      - gravitee_alerts_alertengine_ws_security_password=adminadmin
      ### OPENTELEMETRY
      # - gravitee_services_opentelemetry_enabled=true
      # - gravitee_services_opentelemetry_verbose=true
      # - gravitee_services_opentelemetry_exporter_endpoint=http://jaeger:4318
      # - gravitee_services_opentelemetry_exporter_protocol=http/protobuf
      ### TCP REPORTER (sends JSON events to agent-live-graph for real-time visualization)
      - gravitee_reporters_tcp_enabled=true
      - gravitee_reporters_tcp_host=agent-live-graph
      - gravitee_reporters_tcp_port=9001
      - gravitee_reporters_tcp_output=json
    networks:
      - southbound
      - northbound

  ### Gravitee API Management Management API
  apim-management-api:
    image: ${APIM_REGISTRY:-graviteeio}/apim-management-api:${APIM_VERSION:-latest}
    container_name: gio-apim-management-api
    restart: always
    ports:
      - "8083:8083" # Management API Entrypoint
      - "18083:18083" # Internal API, used for monitoring and management purposes
    depends_on:
      mongodb:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: >
        sh -c '
        response=$$(curl -s -u admin:adminadmin http://localhost:18083/_node/health);
        if echo "$$response" | grep -Eq "\"healthy\"[[:space:]]*:[[:space:]]*false"; then exit 1; else exit 0; fi
        ' > /dev/null
      interval: 2s
      timeout: 2s
      retries: 10
    volumes:
      - ./plugins-apim:/opt/graviteeio-management-api/plugins-ext
    environment:
      ### LICENSE
      - gravitee_license_key=${GRAVITEE_LICENSE}
      ### PLUGINS
      - gravitee_plugins_path_0=/opt/graviteeio-management-api/plugins
      - gravitee_plugins_path_1=/opt/graviteeio-management-api/plugins-ext
      ### Internal API (Core Service)
      - gravitee_services_core_http_host=0.0.0.0
      - gravitee_services_metrics_enabled=true
      ### Gateway URL for displaying in the Developer Portal.
      - gravitee_portal_entrypoint=http://localhost:8082
      ### MANAGEMENT DB - MONGO DB
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=20000&socketTimeoutMS=20000
      ### ANALYTICS DB - ELASTICSEARCH
      - gravitee_analytics_elasticsearch_endpoints_0=http://elasticsearch:9200
      ### INSTALLATION TYPE - STANDALONE (Opposed to multi-tenant)
      - gravitee_installation_type=standalone
      - gravitee_installation_standalone_api_url=http://localhost:8083
      - gravitee_installation_standalone_console_url=http://localhost:8084
      - gravitee_installation_standalone_portal_url=http://localhost:8085/next
      ### ALERT ENGINE
      - gravitee_alerts_alertengine_enabled=true
      - gravitee_alerts_alertengine_ws_discovery=true
      - gravitee_alerts_alertengine_ws_endpoints_0=http://alert-engine:8072
      - gravitee_alerts_alertengine_ws_security_username=admin
      - gravitee_alerts_alertengine_ws_security_password=adminadmin
    networks:
      - southbound
      - northbound

  ### Gravitee API Management Management UI, aka Console
  apim-management-ui:
    image: ${APIM_REGISTRY:-graviteeio}/apim-management-ui:${APIM_VERSION:-latest}
    container_name: gio-apim-management-ui
    restart: always
    ports:
      - "8084:8080"
    depends_on:
      - apim-management-api
    environment:
      - MGMT_API_URL=http://localhost:8083/management/organizations/DEFAULT/environments/DEFAULT/
    networks:
      - northbound

  ### Gravitee API Management Portal UI, aka Developer Portal
  apim-portal-ui:
    image: ${APIM_REGISTRY:-graviteeio}/apim-portal-ui:${APIM_VERSION:-latest}
    container_name: gio-apim-portal-ui
    restart: always
    ports:
      - "8085:8080"
    depends_on:
      - apim-management-api
    environment:
      - PORTAL_API_URL=http://localhost:8083/portal/environments/DEFAULT
      - FRAME_PROTECTION_ENABLED=false
      - ALLOWED_FRAME_ANCESTOR_URLS="http://localhost:8084"
    networks:
      - northbound

  # --- Gravitee Access Management Components ---

  ### Gravitee Access Management Gateway
  am-gateway:
    image: ${AM_REGISTRY:-graviteeio}/am-gateway:${AM_VERSION:-latest} # https://hub.docker.com/r/graviteeio/am-gateway/tags?name=4.10
    container_name: gio-am-gateway
    restart: always
    ports:
      - "8092:8092"
    depends_on:
      mongodb:
        condition: service_healthy
      am-management-api:
        condition: service_started
    environment:
      - gravitee_license_key=${GRAVITEE_LICENSE}
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/graviteeam?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
      - gravitee_oauth2_mongodb_uri=mongodb://mongodb:27017/graviteeam?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
    networks:
      - southbound
      - northbound

  ### Gravitee Access Management Management API
  am-management-api:
    image: ${AM_REGISTRY:-graviteeio}/am-management-api:${AM_VERSION:-latest}
    container_name: gio-am-management-api
    restart: always
    ports:
      - "8093:8093" # Management API Entrypoint
      - "18093:18093" # Internal API, used for monitoring and management purposes
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: >
        sh -c '
        response=$$(curl -s -u admin:adminadmin http://localhost:18093/_node/health);
        if echo "$$response" | grep -Eq "\"healthy\"[[:space:]]*:[[:space:]]*false"; then exit 1; else exit 0; fi
        ' > /dev/null
      interval: 2s
      timeout: 2s
      retries: 10
    environment:
      ### LICENSE
      - gravitee_license_key=${GRAVITEE_LICENSE}
      ### Internal API (Core Service)
      - gravitee_services_core_http_host=0.0.0.0
      - gravitee_services_metrics_enabled=true
      ### MANAGEMENT DB - MONGO DB
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/graviteeam?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
      - gravitee_oauth2_mongodb_uri=mongodb://mongodb:27017/graviteeam?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
      - gravitee_dataPlanes_0_mongodb_uri=mongodb://mongodb:27017/graviteeam?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
    networks:
      - southbound
      - northbound

  ### Gravitee Access Management Management UI
  am-management-ui:
    image: ${AM_REGISTRY:-graviteeio}/am-management-ui:${AM_VERSION:-latest}
    container_name: gio-am-management-ui
    restart: always
    ports:
      - "8081:8080"
    depends_on:
      - am-management-api
    environment:
      - MGMT_API_URL=http://localhost:8093
      - MGMT_UI_URL=http://localhost:8081
    networks:
      - northbound

  # --- OpenFGA Components ---
  ### OpenFGA Postgres
  openfga-postgres:
    image: postgres:17
    container_name: openfga-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=openfga
      - POSTGRES_USER=openfga
      - POSTGRES_PASSWORD=openfga
    volumes:
      - openfga_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U openfga -d openfga" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - southbound

  ### OpenFGA Tables Creation
  openfga-migrate:
    image: openfga/openfga:latest
    container_name: openfga-migrate
    command: migrate
    environment:
      - OPENFGA_DATASTORE_ENGINE=postgres
      - OPENFGA_DATASTORE_URI=postgres://openfga:openfga@openfga-postgres:5432/openfga?sslmode=disable
    depends_on:
      openfga-postgres:
        condition: service_healthy
    networks:
      - southbound

  ### OpenFGA server
  openfga:
    image: openfga/openfga:latest
    container_name: openfga
    command: run
    environment:
      - OPENFGA_DATASTORE_ENGINE=postgres
      - OPENFGA_DATASTORE_URI=postgres://openfga:openfga@openfga-postgres:5432/openfga?sslmode=disable
      - OPENFGA_LOG_FORMAT=json
      - OPENFGA_AUTHN_METHOD=none
    depends_on:
      openfga-migrate:
        condition: service_completed_successfully
    ports:
      - "8086:8080"
      - "8087:8081"
      - "3000:3000"
    networks:
      - southbound

  # --- Gravitee Initialization ---

  ### Gravitee Init Container
  gravitee-init:
    build:
      context: ./gravitee-init
      dockerfile: Dockerfile
    container_name: gio-gravitee-init
    restart: "no"
    depends_on:
      am-management-api:
        condition: service_healthy
      apim-management-api:
        condition: service_healthy
      openfga:
        condition: service_started
    environment:
      # Access Management (AM) configuration
      - AM_BASE_URL=http://am-management-api:8093
      - AM_USERNAME=admin
      - AM_PASSWORD=adminadmin
      # API Management (APIM) configuration
      - APIM_BASE_URL=http://apim-management-api:8083
      - APIM_USERNAME=admin
      - APIM_PASSWORD=admin
      - API_DEFINITIONS_DIR=/app/apim-apis
      # OpenFGA configuration
      - FGA_BASE_URL=http://openfga:8080
      - FGA_CONFIG_FILE=/app/openfga/openfgastore.yaml
      # Common configuration
      - ORGANIZATION=DEFAULT
      - ENVIRONMENT=DEFAULT
    networks:
      - southbound

  # --- Alert Engine Components ---

  ### Alert Engine
  alert-engine:
    image: graviteeio/ae-engine:${AE_VERSION:-latest} # https://hub.docker.com/r/graviteeio/ae-engine/tags?name=2
    container_name: gio-alert-engine
    restart: always
    environment:
      - gravitee_license_key=${GRAVITEE_LICENSE}
    networks:
      - southbound

  # --- AI Agents Components ---

  # ### Ollama LLM Runtime (Optional - prefer local Ollama)
  # ollama:
  #   image: ollama/ollama:${OLLAMA_VERSION:-latest} # https://hub.docker.com/r/ollama/ollama/tags
  #   container_name: ollama-llm-runtime
  #   restart: unless-stopped
  #   # ports:
  #   #   - "11434:11434" # Commented out to avoid conflicts if Ollama is already running on the host
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   environment:
  #     - OLLAMA_HOST=0.0.0.0
  #   healthcheck:
  #     test: ["CMD", "/bin/sh", "-c", "ollama list | grep -q 'qwen3:4b'"]
  #     interval: 5s
  #     timeout: 10s
  #     retries: 60 # Accomodate for qwen3:4b model download time
  #     start_period: 5s
  #   entrypoint: ["/bin/sh", "-c"]
  #   command: 
  #     - |
  #       ollama serve &
  #       sleep 5
  #       ollama pull qwen3:4b || true
  #       wait
  #   networks:
  #     - southbound

  ### Hotel Booking Fake API
  hotel-booking-api:
    build:
      context: ./hotel-booking-api
      dockerfile: Dockerfile
    container_name: hotel-booking-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 3s
    networks:
      - southbound

  ### Hotel Website
  hotel-website:
    build:
      context: ./hotel-website
      dockerfile: Dockerfile
    container_name: hotel-website
    restart: unless-stopped
    ports:
      - "8002:80"
    environment:
      - AGENT_CARD_URL=http://localhost:8082/bookings-agent/.well-known/agent-card.json
      - OIDC_URL=http://localhost:8092/gravitee/oidc/.well-known/openid-configuration
      - CLIENT_ID=gravitee-hotels
      - CLIENT_SECRET=gravitee-hotels
      - REDIRECT_URI=http://localhost:8002/
    networks:
      - northbound

  ### A2A Agent
  hotel-booking-a2a-agent:
    build:
      context: .
      dockerfile: ./hotel-booking-a2a-agent/Dockerfile
    container_name: hotel-booking-a2a-agent
    depends_on:
      hotel-booking-api:
        condition: service_healthy
      apim-gateway:
        condition: service_healthy
    environment:
      - LLM_BASE_URL=http://gio-apim-gateway:8082/llm-proxy
      - LLM_MODEL=ollama:qwen3:4b
      - LLM_TEMPERATURE=0.3
      - MCP_HTTP_URLS=http://gio-apim-gateway:8082/hotels/mcp
      - AGENT_SERVER_PORT=8001
      - OIDC_DISCOVERY_URL=http://am-gateway:8092/gravitee/oidc/.well-known/openid-configuration
      - AM_TOKEN_URL=http://gio-am-gateway:8092/gravitee/oauth/token
      - AM_CLIENT_ID=hotel-booking-agent
      - AM_CLIENT_SECRET=hotel-booking-agent
    ports:
      - "8001:8001"
    restart: unless-stopped
    networks:
      - southbound

  currency-converter-a2a-agent:
    build:
      context: ./currency-converter-a2a-agent
      dockerfile: Dockerfile
    image: currency-converter-a2a-agent:local
    container_name: currency-converter-a2a-agent
    ports:
      - "10000:10000"
    environment:
      STREAMING: "true"
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    networks:
        - southbound

  # --- Demo Components ---

  ## MCP Inspector
  mcp-inspector:
    image: ghcr.io/modelcontextprotocol/inspector:${MCP_INSPECTOR_VERSION:-latest}
    container_name: mcp-inspector
    ports:
      - "6274:6274"
      - "6277:6277"
    restart: unless-stopped
    environment:
      - DANGEROUSLY_OMIT_AUTH=true # Access MCP Inspector UI without Authentication
      - HOST=0.0.0.0
    networks:
      - southbound
      - northbound
  
  ## A2A Inspector
  a2a-inspector:
    image: dobl1/a2a-inspector:latest
    container_name: a2a-inspector
    ports:
      - "8004:8080"
    restart: unless-stopped
    networks:
      - southbound
      - northbound

  # --- Observability Components ---

  ### Jaeger (OpenTelemetry traces UI)
  # jaeger:
  #   image: jaegertracing/jaeger:2.15.1
  #   container_name: jaeger
  #   restart: unless-stopped
  #   ports:
  #     - "16686:16686" # Jaeger UI
  #     - "4317:4317"   # OTLP gRPC receiver
  #     - "4318:4318"   # OTLP HTTP receiver
  #   environment:
  #     - COLLECTOR_OTLP_ENABLED=true
  #   networks:
  #     - southbound
  #     - northbound

  ### Agent Live Graph (real-time flow visualization)
  agent-live-graph:
    build:
      context: ./agent-live-graph
      dockerfile: Dockerfile
    container_name: agent-live-graph
    restart: unless-stopped
    ports:
      - "9002:9002" # Web UI + WebSocket
    environment:
    ### Web UI Configuration
      - HTTP_PORT=9002 # Port for serving the Web UI and WebSocket
    ### Gravitee Gateways Logs & Metrics
      - TCP_PORT=9001 # Port for receiving TCP events from the APIM Gateway's TCP Reporter
    networks:
      - southbound
      - northbound

  # --- Volumes and Networks ---

volumes:
  data-mongo:
    driver: local
  data-elasticsearch:
    driver: local
  data-kibana:
    driver: local
  ollama_data:
    driver: local
  openfga_postgres_data:
    driver: local

networks:
  northbound: # Consumer/Client-facing
    name: northbound
  southbound: # Upstream/Backend-facing
    name: southbound